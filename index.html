<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
    <script type="text/javascript">
        function initGovMap() {
            govmap.createMap('map', {
                onClick: function (e) {
                    console.log('onClick', e);
                },
                onPan: function (e) {
                    console.log('onPan', e);
                },
                token: 'ede9a5fd-7c23-432f-8ffb-d85feffa3f3c',
                layers: ["GASSTATIONS","PARCEL_HOKS", "KSHTANN_ASSETS", "bus_stops", "PARCEL_ALL","219111","219113","219114"],
                showXY: true,
                identifyOnClick: true,
                isEmbeddedToggle: true,
                background: "2",
                layersMode: 1,
                zoomButtons: false,
                center: { x: 194366, y: 665500 }
            });
        }
        
        function showExample(){
            console.log('showExample function called');
            document.getElementById('results').innerHTML = '<p>מתחיל ציור מלבן... לחץ פעמיים על המפה כדי לסיים</p>';
            
            var params = {
                continous: false,
                drawType: govmap.drawType.Rectangle,
                filterLayer: false,
                isZoomToExtent: true,
                layers: ["GASSTATIONS","PARCEL_HOKS", "KSHTANN_ASSETS", "bus_stops", "PARCEL_ALL","219111","219113","219114"]
                // Remove returnFields to get all fields
            }
            
            console.log('Calling selectFeaturesOnMap with params:', params);
            
            govmap.selectFeaturesOnMap(params).then(function(response) {
                console.log('SUCCESS - Response received:', response);
                
                // Count results per layer
                var html = '<h3>תוצאות:</h3>';
                var totalCount = 0;
                
                for (var layer in response) {
                    if (response.hasOwnProperty(layer) && Array.isArray(response[layer])) {
                        var count = response[layer].length;
                        totalCount += count;
                        html += '<h4>' + layer + ': ' + count + ' פריטים</h4>';
                        
                        if (count > 0) {
                            html += '<ul>';
                            response[layer].forEach(function(item, index) {
                                if (index < 5) { // Show only first 5 items per layer
                                    html += '<li><pre>' + JSON.stringify(item, null, 2) + '</pre></li>';
                                }
                            });
                            if (count > 5) {
                                html += '<li>... ועוד ' + (count - 5) + ' פריטים</li>';
                            }
                            html += '</ul>';
                        }
                    }
                }
                
                if (totalCount === 0) {
                    html += '<p>לא נמצאו תוצאות באזור שנבחר</p>';
                }
                
                document.getElementById('results').innerHTML = html;
            }).catch(function(error) {
                console.error('ERROR caught:', error);
                document.getElementById('results').innerHTML = 
                    '<p style="color:red;">שגיאה: ' + JSON.stringify(error) + '</p>';
            });
        }
    </script>
</head>
<body>
    <div id="map" style="width:900px;height:600px;"></div>
    <button onClick="showExample()">Show Example</button>
    <div id="results" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; max-height: 500px; overflow: auto;">
        לחץ על "Show Example" כדי להתחיל
    </div>
</body>
</html>
